# Stripe Webhook Setup with Supabase

This guide explains how to set up Stripe webhooks using Supabase Edge Functions.

## Overview

Instead of using a traditional API endpoint, we use Supabase Edge Functions to handle Stripe webhooks. This provides:
- Automatic scaling
- Built-in security
- Direct database integration
- No additional server required

## Setup Steps

### 1. Deploy Database Migrations

First, run the migration to create the necessary tables:

```bash
# Using Supabase CLI
supabase db push

# Or run manually in Supabase SQL Editor
# Copy contents of supabase/migrations/001_stripe_webhooks.sql
```

### 2. Deploy Edge Functions

Deploy the Stripe webhook handler:

```bash
# Install Supabase CLI if not already installed
npm install -g supabase

# Login to Supabase
supabase login

# Link your project
supabase link --project-ref vxvitkusmtukyjrdjhqk

# Deploy the webhook function
supabase functions deploy stripe-webhook

# Deploy the order sync function
supabase functions deploy sync-order-to-medusa
```

### 3. Set Environment Variables

In your Supabase dashboard:
1. Go to Settings > Edge Functions
2. Add the following secrets:
   - `STRIPE_SECRET_KEY`: Your Stripe secret key
   - `STRIPE_WEBHOOK_SECRET`: Will be generated by Stripe
   - `MEDUSA_BACKEND_URL`: Your Medusa backend URL
   - `MEDUSA_API_KEY`: Your Medusa API key
   - `MEDUSA_REGION_ID`: Your Medusa region ID

### 4. Configure Stripe Webhook

1. Go to your Stripe Dashboard
2. Navigate to Developers > Webhooks
3. Click "Add endpoint"
4. Enter the endpoint URL:
   ```
   https://vxvitkusmtukyjrdjhqk.supabase.co/functions/v1/stripe-webhook
   ```
5. Select events to listen to:
   - `payment_intent.succeeded`
   - `payment_intent.payment_failed`
   - `checkout.session.completed`
   - `customer.created`
   - `customer.updated`
6. Copy the webhook signing secret
7. Update your Supabase Edge Function with the webhook secret

### 5. Test the Webhook

Use Stripe CLI to test locally:

```bash
# Install Stripe CLI
brew install stripe/stripe-cli/stripe

# Login to Stripe
stripe login

# Forward webhooks to your local function
stripe listen --forward-to https://vxvitkusmtukyjrdjhqk.supabase.co/functions/v1/stripe-webhook

# Trigger a test event
stripe trigger payment_intent.succeeded
```

## How It Works

1. **Stripe sends webhook** to your Supabase Edge Function
2. **Edge Function verifies** the webhook signature
3. **Event is stored** in the `stripe_webhooks` table
4. **Database trigger** processes the event automatically
5. **Order is synced** with Medusa when payment succeeds

## Database Schema

The webhook system uses these tables:

- `stripe_webhooks`: Stores all incoming webhook events
- `payments`: Tracks payment records
- `orders`: Stores order information
- `profiles`: User profiles with Stripe customer IDs

## Monitoring

View webhook activity in your Supabase dashboard:

```sql
-- View recent webhooks
SELECT * FROM stripe_webhooks 
ORDER BY created_at DESC 
LIMIT 20;

-- View failed webhooks
SELECT * FROM stripe_webhooks 
WHERE processed = false OR error IS NOT NULL
ORDER BY created_at DESC;

-- View successful payments
SELECT * FROM payments 
WHERE status = 'succeeded'
ORDER BY created_at DESC;
```

## Troubleshooting

### Webhook Signature Verification Failed
- Ensure the webhook secret in Supabase matches Stripe
- Check that you're using the raw request body

### Database Function Not Found
- Run the migration script
- Check function permissions

### Orders Not Syncing with Medusa
- Verify Medusa API credentials
- Check the sync-order-to-medusa function logs
- Ensure Medusa backend is accessible

## Security

- Webhook endpoint is protected by signature verification
- Database functions use RLS (Row Level Security)
- Sensitive data is stored as environment variables
- All webhook events are logged for audit trail